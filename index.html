  <!DOCTYPE html>
  <html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper Valley</title>
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
    <style>
      body {
        margin: 0;
        background-color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      canvas {
        border: 2px solid #fff;
        image-rendering: pixelated;
      }
    </style>
  </head>
  <body>
    <canvas id="meu_canvas" width="1000" height="700"></canvas>

    <!--  Importação dos scripts (ordem é importante) -->
  <script src="dialogos.js"></script>
  <script src="Cutscene.js"></script>
  <script src="eventosMapa.js"></script>
  <script src="cemeteryPuzzle.js"></script>
  <script src="churchPuzzle.js"></script>
  <script src="ruinsPuzzle.js"></script>
  <script src="lakePuzzle.js"></script>
  <script src="Map.js"></script>
  <script src="colisoes.js"></script>
  <script src="npc.js"></script>
  <script src="itens.js"></script>
  <script src="Final.js"></script>
  <script src="falaInicial.js"></script> 
  <script src="Player.js"></script>
  <script src="teclado.js"></script>
  <script src="Som.js"></script>



  <script>
  const canvas = document.getElementById('meu_canvas');
  const ctx = canvas.getContext('2d');

  // ------------------ CUTSCENES ------------------
  const logo = new Cutscene('assets/logo.png', []);
  const instrucoes = new Cutscene('assets/instrucoes.jpg', []);
  const cutsceneHistoria = { ativa: false };
  const cutscene1 = new Cutscene('assets/cena-1.png', dialogos.cena1);
  const cutscene2 = new Cutscene('assets/cena-2.png', dialogos.cena2);
  const cutscene3 = new Cutscene('assets/cena-3.png', dialogos.cena3);
  const cutscene4 = new Cutscene('assets/cena-4.png', []);
  const finalJogo = new Final(canvas, ctx);
  const cenas = [logo, instrucoes, cutsceneHistoria, cutscene1, cutscene2, cutscene3, cutscene4];
  let cenaAtual = 0;
  let currentCutscene = cenas[cenaAtual];

  // ------------------ JOGO ------------------
  let mapa, player;
  let jogoAtivo = false;
  let npc = null;

  const musicaFundo = new Som("assets/audio/musica.mp3");

  // toca música após interação do jogador
  window.addEventListener("keydown", () => {
    musicaFundo.tocar();
  }, { once: true });

  function iniciarJogo() {
    mapa = new Map('assets/mapa_jogo.webp', canvas, ctx);
    player = new Player(canvas, 1650, 2950);
    CemeteryPuzzle.init({ x: 2900, y: 200, w: 1100, h: 600 });

      ChurchPuzzle.init({
          x: 5450,   // alterar para onde você quer no mapa (coordenadas do mundo)
          y: 800,
          w: 300,
          h: 300,
          orientationVisible: false, // Mostra a orientação da área do puzzle
          symbols: [
          "assets/simbolos/chave.jpg",
          "assets/simbolos/fragmento.jpg",
          "assets/simbolos/sol.jpg",
          "assets/simbolos/triangulo.jpg"
          ],
          correctSequence: [1,3,0,2] // exemplo de ordem correta (índices)
      });

      RuinsPuzzle.init({
        x: 10250, 
        y: 3373, 
        w: 600,  
        h: 600,  
        orientationVisible: false // mostra quadrado vermelho de orientação
      });

      LakePuzzle.init({
        x: 5487,
        y: 5470,
        w: 200,
        h: 200,
        orientationVisible: false
      });
    
    
    // Falas dos NPCs
    npc = new NPC(5680, 2750, 400, 200, [
    "Sebastião: Whisper Valley guarda segredos que nem o vento ousa contar...",
    "Sebastião: À noite, as vozes chamam do lago.",
    "Sebastião: Você escuta se ficar em silêncio por tempo demais.",
    "Sebastião: Foi assim que Daniel se perdeu."
  ]);

  npc2 = new NPC(3320, 2500, 400, 200, [
      "João: Os moradores... eles não são mais os mesmos.",
      "João: Olhos que não piscam... sorrisos que não alcançam o rosto.",
      "João: Dizem que Sofia tentou ir embora... mas a floresta não deixou."
    ], "assets/npc-2.png");
    
    npc3 = new NPC(6000, 1270, 400, 200, [
    "Ana: Abraxas... esse nome ainda ecoa aqui.",
    "Ana: Alguns o chamam de deus. Outros, de punição.",
    "Ana: Jonas... ele acreditou demais. E agora está em silêncio como o resto.",
    "Ethan: Abraxas outra vez...",
    "Ethan: Todos falam desse nome como se fosse uma sombra viva.",
    "Ethan: Parece que cheguei mais perto do que devia."
  ], "assets/npc-3.png");

    npc4 = new NPC(2490, 1010, 400, 200, [
    "Weverson: Você é novo por aqui, não é?!",
    "Weverson: Então escute bem... há algo que domina essa cidade.",
    "Weverson: Uma seita... chamam de Abraxas.",
    "Weverson: Eles observam tudo. E não gostam de forasteiros curiosos.",
    "Weverson: Tome cuidado... nem todos que sorriem aqui são humanos por completo.",
  ], "assets/npc-4.png");

  npc5 = new NPC(3000, 4990, 400, 200, [
    "Helena: A seita pode ser vencida... mas não com força.",
    "Helena: Há um item... antigo. Escondido onde a névoa toca o chão.",
    "Helena: Miguel... ele também o procurava.",
    "Ethan: Miguel também...?",
    "Ethan: Então ele realmente esteve aqui.",
    "Ethan: O que você estava tentando me mostrar, amigo?"
  ], "assets/npc-5.png");

    mapa.onReady = () => {
      jogoAtivo = true;
      mapa.atualizarCamera(player);
      iniciarFalaInicial();
    };
  }

  // ------------------ HISTÓRIA (efeito de digitação) ------------------
  let historiaTexto = 
    "O protagonista, Ethan Graves, é um jornalista que costuma\n" +
    "se sair bem em suas matérias, mas tudo muda quando seu\n" +
    "melhor amigo, Miguel, desaparece misteriosamente em uma\n" +
    "floresta. Depois desse acontecimento, seu desempenho\n" +
    "cai e ele precisa escrever uma matéria urgente para o\n" +
    "jornal em que trabalha, caso contrário será demitido.\n" +
    "A mando de seu chefe, Ethan viaja para uma cidade\n" +
    "escondida entre as árvores, em busca de desvendar os\n" +
    "mistérios do lugar: Whisper Valley.";

  let textoAtual = "";
  let indiceLetra = 0;
  let textoTerminado = false;
  const alturaLinha = 30; // altura de cada linha
  let intervaloTexto;

  function iniciarHistoria() {
    cutsceneHistoria.ativa = true;
    textoAtual = "";
    indiceLetra = 0;
    textoTerminado = false;

    intervaloTexto = setInterval(() => {
      if (indiceLetra < historiaTexto.length) {
        textoAtual += historiaTexto[indiceLetra];
        indiceLetra++;
      } else {
        textoTerminado = true;
        clearInterval(intervaloTexto);
      }
    }, 40); // velocidade da digitação em ms
  }

  function desenharHistoria() {
    ctx.fillStyle = "white";
    ctx.font = "22px monospace";

    const linhas = textoAtual.split("\n");
    const blocoAltura = linhas.length * alturaLinha;
    let posY = (canvas.height - blocoAltura) / 2; // centraliza verticalmente

    for (let linha of linhas) {
      const largura = ctx.measureText(linha).width;
      const x = (canvas.width - largura) / 2; // centraliza horizontalmente
      ctx.fillText(linha, x, posY);
      posY += alturaLinha;
    }

    ctx.font = "18px monospace";
    ctx.fillStyle = "rgba(255,255,255,0.6)";
    ctx.fillText("ESPAÇO para avançar", canvas.width - 260, canvas.height - 30);
  }

  // ------------------ LOOP DE ATUALIZAÇÃO ------------------
  function atualizar() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);


    if (jogoAtivo) {
      mapa.desenhar(player);
      

      if (falaInicialAtiva) {
      desenharFalaInicial(ctx, canvas);
      
    }

      // checa interação e desenha NPC
    if (npc) {
      npc.checarInteracao(player);
      npc.desenhar(ctx, mapa);
    }

      if (npc2) {
      npc2.checarInteracao(player);
      npc2.desenhar(ctx, mapa);
    }

      if (npc3) {
      npc3.checarInteracao(player);
      npc3.desenhar(ctx, mapa);
    }

    if (npc4) {
    npc4.checarInteracao(player);
    npc4.desenhar(ctx, mapa);
  }

    if (npc5) {
      npc5.checarInteracao(player);
      npc5.desenhar(ctx, mapa);
    }
    
    CemeteryPuzzle.draw(ctx, mapa, player);
    ChurchPuzzle.draw(ctx, mapa, player);
    RuinsPuzzle.draw(ctx, mapa, player);
    LakePuzzle.draw(ctx, mapa, player);
    player.desenhar(ctx, mapa);
    

      desenharColisoes(ctx, mapa.cameraX, mapa.cameraY, mapa.zoom);
      desenharItens(ctx, mapa);

      verificarCutscene5(player);
      verificarCutscene7(player); // nova verificação da cutscene 7
      verificarCutscene8(player);
      verificarCutscene9(player);
      verificarCutscene10(player);

      desenharPontoCutscene(ctx, mapa);
      desenharPontoCutscene7(ctx, mapa); 
      desenharPontoCutscene8(ctx, mapa);
      desenharPontoCutscene9(ctx, mapa);
      desenharPontoCutscene10(ctx, mapa);

    } else if (cutsceneHistoria.ativa) {
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      desenharHistoria();
    } else {
      currentCutscene.desenhar(ctx, canvas);
    }

            if (jogoAtivo && finalJogo.ativa === false) {
        if (finalJogo.todosPuzzlesCompletos()) {
          finalJogo.iniciar();
          jogoAtivo = false; // bloqueia o mapa enquanto a cutscene final estiver ativa
        }
      }


      if (finalJogo.ativa) {
        finalJogo.desenhar();
        return; // bloqueia o resto enquanto o final estiver ativo
      }

    requestAnimationFrame(atualizar);
  }

  // ------------------ TECLADO ------------------
  inicializarTeclado({
    onEspaco: () => {
          if (finalJogo.fimTelaFinal) {
      finalJogo.reiniciar();
      return;
    }
    finalJogo.avancarFala();
        if (jogoAtivo) {
          tentarColetarItem();
          // Interagir com o puzzle do cemitério
        if (CemeteryPuzzle && CemeteryPuzzle.playerInArea && CemeteryPuzzle.showModal) {
          if (CemeteryPuzzle.playerInArea(player, mapa)) {
            CemeteryPuzzle.showModal();
            return;
          }
        }

        if (ChurchPuzzle && ChurchPuzzle.playerInArea && ChurchPuzzle.showModal) {
          if (ChurchPuzzle.playerInArea(player, mapa)) {
            ChurchPuzzle.showModal();
            return;
          }
        }

        if (RuinsPuzzle && RuinsPuzzle.playerInArea && RuinsPuzzle.showModal) {
          if (RuinsPuzzle.playerInArea(player, mapa)) {
            RuinsPuzzle.showModal();
            return;
          }
        }

        if (LakePuzzle && LakePuzzle.playerInArea && LakePuzzle.showModal) {
          if (LakePuzzle.playerInArea(player, mapa)) {
            LakePuzzle.showModal();
            return;
          }
        }

    
    if (falaInicialAtiva) {
    if (falaTerminou) {
      falaInicialAtiva = false;
    } else {
      clearInterval(intervaloFala);
      textoFalaAtual = textoFala;
      falaTerminou = true;
    }
    return;
  }

    if (npc && npc.mensagemVisivel) {
      npc.interagir();
      return;
    }
    if (npc2 && npc2.mensagemVisivel) {
      npc2.interagir();
      return;
    }
      if (npc3 && npc3.mensagemVisivel) {
      npc3.interagir();
      return;
    }

    if (npc4 && npc4.mensagemVisivel) {
    npc4.interagir();
    return;
  }
    
  if (npc5 && npc5.mensagemVisivel) {
    npc5.interagir();
    return;
  }

  }

      if (!jogoAtivo) {
        // caso esteja na história
        if (cutsceneHistoria.ativa) {
          if (!textoTerminado) {
            // se ainda está escrevendo o texto → pular tudo
            clearInterval(intervaloTexto);
            textoAtual = historiaTexto;
            textoTerminado = true;
          } else {
            // se já terminou → ir para próxima cutscene
            cutsceneHistoria.ativa = false;
            cenaAtual++;
            currentCutscene = cenas[cenaAtual];
          }
          return;
        }

        // outras cutscenes
        if (currentCutscene.falas.length === 0) {
          cenaAtual++;
          if (cenaAtual < cenas.length) {
            currentCutscene = cenas[cenaAtual];
            if (currentCutscene === cutsceneHistoria) {
              iniciarHistoria();
            }
          } else {
            iniciarJogo();
          }
        } else {
          currentCutscene.avancarFala();

        if (currentCutscene.finalizada) {

    //  Se for a cutscene5, inicia automaticamente a cutscene6
    if (currentCutscene.cutsceneEspecial === "cutscene5" && currentCutscene.proximaCutscene === "cutscene6") {
      iniciarCutscene6();
      return;
    }

    //  Se for a cutscene6 (última da sequência), retoma o jogo
    if (currentCutscene.cutsceneEspecial === "cutscene6") {
      jogoAtivo = true;

      // Restaura posição do jogador
      if (pontoCutscene5.posicaoJogador) {
        player.x = pontoCutscene5.posicaoJogador.x;
        player.y = pontoCutscene5.posicaoJogador.y;
      }

      currentCutscene = null;
      return;
    }

    if (currentCutscene.cutsceneEspecial === "cutscene7") {
          jogoAtivo = true;
          // Restaura posição do jogador
          if (pontoCutscene7.posicaoJogador) {
              player.x = pontoCutscene7.posicaoJogador.x;
              player.y = pontoCutscene7.posicaoJogador.y;
          }
          currentCutscene = null;
          return;
      }

      if (currentCutscene.cutsceneEspecial === "cutscene8") {
    jogoAtivo = true;
    if (pontoCutscene8.posicaoJogador) {
      player.x = pontoCutscene8.posicaoJogador.x;
      player.y = pontoCutscene8.posicaoJogador.y;
    }
    currentCutscene = null;
    return;
  }

  if (currentCutscene.cutsceneEspecial === "cutscene9") {
    jogoAtivo = true;
    if (pontoCutscene9.posicaoJogador) {
      player.x = pontoCutscene9.posicaoJogador.x;
      player.y = pontoCutscene9.posicaoJogador.y;
    }
    currentCutscene = null;
    return;
  }

  if (currentCutscene.cutsceneEspecial === "cutscene10") {
    jogoAtivo = true;
    if (pontoCutscene10.posicaoJogador) {
      player.x = pontoCutscene10.posicaoJogador.x;
      player.y = pontoCutscene10.posicaoJogador.y;
    }
    currentCutscene = null;
    return;
  }

    //  Caso contrário, segue o fluxo normal das cutscenes iniciais
    cenaAtual++;
    if (cenaAtual < cenas.length) {
      currentCutscene = cenas[cenaAtual];
      if (currentCutscene === cutsceneHistoria) {
        iniciarHistoria();
      }
    } else {
      iniciarJogo();
    }
  }
        }
      }

        if (finalJogo.ativa) {
      if (!finalJogo.fimTelaFinal) {
          finalJogo.avancarFala();
      } else {
          finalJogo.reiniciar();
      }
      return; // bloqueia ações do jogo
}
    },
    onMover: (direcao) => {
    // se a fala inicial estiver ativa, impede qualquer movimento
    if (!jogoAtivo || !mapa || !player || typeof falaInicialAtiva !== 'undefined' && falaInicialAtiva) return;
    player.mover(direcao, mapa);
  }
  });

  // ------------------ PRÉ-CARREGAR IMAGENS ------------------
  function carregarImagens(cenas, callback) {
    let carregadas = 0;
    const total = cenas.length - 1; // cutsceneHistoria não tem imagem

    for (const cena of cenas) {
      if (cena.imagem) {
        cena.imagem.onload = () => {
          carregadas++;
          if (carregadas === total) callback();
        };
      } else {
        carregadas++;
        if (carregadas === total) callback();
      }
    }
    
  }

  carregarImagens(cenas, () => {
    atualizar();
  });
  </script>
  </body>
  </html>
